# 变更：建立 B 站热榜视频分析能力

## 背景
- 当前内容生成缺少国内热点来源，无法快速基于高热度素材创作漫画/剧情。
- 需要可靠的 B 站热榜数据输入，并对标题/标签做结构化分析，支持前端按主题/分区筛选。
- 现有服务未覆盖 B 站数据源，缺少抓取、存储与分析链路。

## 目标与交付
- 稳定按周期（默认每日，可配置）抓取 B 站热榜前 N 条视频，完成去重、校验、入库与缓存。
- 提取并存储核心字段：bvid/aid、标题、封面、作者、分区、时长、发布时间、播放/点赞/投币/收藏/分享/弹幕等互动指标、标签/关键词、原始响应。
- 生成基础分析：热度评分（按互动指标加权）、分区分布、关键词权重（基于标题+标签分词）。
- 提供 API：列表查询（分页/分区/关键词/时间窗口/排序）、单视频详情、分析摘要。
- 补充日志与监控，覆盖抓取成功率、耗时、限流/异常统计。

## 范围
- 采集：使用公开热门接口（如 `/x/web-interface/popular`），必要时以热门页 HTML 解析兜底。
- 存储与缓存：数据库持久化（依据现有栈选 SQLite/Postgres），附加缓存层以加速列表读取；设置数据过期（建议 3-7 天）。
- 分析：关键词提取（如 jieba/textrank），热度分权重方案可配置，默认基于播放/点赞/收藏/投币/分享/弹幕。

## 非目标
- 不做登录/鉴权；仅使用公开接口/页面数据。
- 不抓取弹幕/评论全文；仅保留概要指标。
- 不提供视频下载或转码。

## 方案概述
- 数据源抽象：封装抓取器，支持接口模式与 HTML 兜底，带 UA、重试、速率/超时控制。
- 数据模型：标准化字段并保留 raw JSON；主键 bvid（或 aid 兼容），记录创建/更新时间与数据来源。
- 清洗与校验：必填字段校验（bvid/title/stat），去重逻辑（按 bvid/aid），字段缺失降级处理。
- 分析逻辑：热度分默认公式（示例）`score = 播放*α + 点赞*β + 收藏*γ + 投币*δ + 分享*ε + 弹幕*ζ`，系数配置化；输出关键词/分区分布。
- API 设计（FastAPI）：`/api/bilibili/hot`（列表+筛选+排序）、`/api/bilibili/hot/{bvid}`（详情）、`/api/bilibili/hot/summary`（热度/分区/关键词摘要）；返回数据含分页信息。
- 作业调度：后台定时任务（沿用现有 Python 服务），任务日志记录抓取量、失败原因、耗时；异常时可熔断或降低频率。
- 配置项：抓取频率、前 N 条数量、UA、超时、重试次数、并发/间隔、缓存 TTL、热度权重。

## 影响面
- Specs：需新增 “bilibili-hot-video-analysis” 能力（后续补 delta）。
- 后端：新增采集/分析任务、数据模型、API、配置与监控。
- 前端：后续新增热点列表/筛选/详情展示入口。

## 风险与缓解
- 反爬或接口突变：多 UA + 间隔控制；预置 HTML 兜底；监控错误率并快速调整解析。
- 字段缺失或格式变化：校验必填，缺失字段回退为 null 并记录 raw；解析异常告警。
- 频率/限流：配置化频率与速率上限，触发 429/403 时自动降频或暂停；支持手动恢复。

## 验收要点
- 抓取成功率与数据覆盖：默认每日至少抓取前 N 条，失败自动重试且有日志。
- API 正常返回：列表可分页/筛选/排序；详情可按 bvid 查询；摘要包含热度/分区/关键词。
- 分析可配置：热度权重、关键词提取参数可通过配置调整。
